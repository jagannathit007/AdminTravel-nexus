<div class="container-fluid">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-header bg-gradient-primary d-flex justify-content-between align-items-center py-3">
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-calendar-event me-2"></i>Event Status Update
      </h4>
    </div>
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex w-100 align-items-center flex-wrap gap-2">
          <div class="flex-grow-1" style="min-width: 200px;">
            <input type="text" class="form-control"
                  placeholder="Search events..."
                  [(ngModel)]="searchQuery"
                  (input)="onSearch()">
          </div>
          <div style="min-width: 150px;">
            <select class="form-select" [(ngModel)]="selectedEventType" (change)="onEventTypeFilterChange()">
              <option *ngFor="let option of eventTypeOptions" [value]="option.value">
                {{option.label}}
              </option>
            </select>
          </div>
          <div style="min-width: 150px;">
            <select class="form-select" [(ngModel)]="selectedEventPrice" (change)="onEventPriceFilterChange()">
              <option *ngFor="let option of eventPriceOptions" [value]="option.value">
                {{option.label}}
              </option>
            </select>
          </div>
          <div>
            <ng-select [items]="[10,25,50,100]" (change)="onChange()" [(ngModel)]="payload.limit" placeholder="Items per page"></ng-select>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="loading" class="text-center my-5 py-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div class="table-responsive" *ngIf="!loading && events?.docs && events.docs.length > 0">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 py-3">Serial No.</th>
            <th class="py-3">Title</th>
            <th class="py-3">Start Date</th>
            <th class="py-3">End Date</th>
            <th class="py-3">Event Type</th>
            <th class="py-3">Price</th>
            <th class="py-3">Created At</th>
            <th class="text-end pe-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let event of events.docs | paginate: { itemsPerPage: payload.limit, currentPage: payload.page, totalItems: events.totalDocs }; let i=index" class="border-bottom">
            <td class="ps-4 py-3">{{events.pagingCounter + i}}</td>
            <td class="py-3">
              <div class="fw-bold text-dark">{{event.title || event.name || 'Untitled'}}</div>
            </td>
            <td class="py-3">{{formatDate(event.startDate)}}</td>
            <td class="py-3">{{formatDate(event.endDate)}}</td>
            <td class="py-3">
              <span class="badge rounded-pill" [ngClass]="{'bg-info': event.eventType === 'online', 'bg-primary': event.eventType === 'offline', 'bg-secondary': event.eventType === 'hybrid'}">
                {{event.eventType || 'N/A' | titlecase}}
              </span>
            </td>
            <td class="py-3">
              <span class="badge rounded-pill" [ngClass]="{'bg-success': event.isPaid, 'bg-warning': !event.isPaid}">
                {{event.isPaid ? 'Paid' : 'Free'}}
              </span>
            </td>
            <td class="py-3">{{formatDate(event.createdAt)}}</td>
            <td class="text-end pe-4 py-3">
              <button class="btn btn-sm btn-outline-primary rounded-pill" (click)="openViewRegistrationsModal(event)">
                <i class="bi bi-eye me-2"></i>View Registrations
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="d-flex justify-content-end p-3">
        <pagination-controls (pageChange)="onPageChange($event)"></pagination-controls>
      </div>
    </div>

    <div *ngIf="!loading && (!events?.docs || events?.docs?.length === 0)" class="text-center my-5 py-4 px-4">
      <div class="empty-state">
        <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
        <h5>No Events Found</h5>
        <p class="text-muted">Try adjusting your search criteria.</p>
      </div>
    </div>
  </div>
</div>

<!-- Registration Details Modal -->
<div class="modal fade" id="registrationDetailsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog" aria-labelledby="registrationDetailsModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen" role="document">
    <div class="modal-content border-0 shadow rounded-0 overflow-hidden">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold" id="registrationDetailsModalTitle">
          <i class="bi bi-person-check me-2"></i> Registration Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" *ngIf="selectedRegistrationDetails">
        <div class="row g-4">
          <!-- User Information -->
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="bi bi-person-circle me-2"></i>User Information</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3 text-center mb-3 mb-md-0">
                    <img [src]="getUserImageUrl(selectedRegistrationDetails)" 
                         [alt]="getUserName(selectedRegistrationDetails.userDetails)"
                         class="img-fluid rounded-circle border border-3 border-primary"
                         style="width: 120px; height: 120px; object-fit: cover;"
                         onerror="this.src='assets/images/placeholder-image.png'">
                  </div>
                  <div class="col-md-9">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label text-muted small mb-1">Name</label>
                        <p class="mb-0 fw-bold">{{getUserName(selectedRegistrationDetails.userDetails)}}</p>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label text-muted small mb-1">Email</label>
                        <p class="mb-0">{{getUserEmail(selectedRegistrationDetails.userDetails)}}</p>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label text-muted small mb-1">User ID</label>
                        <p class="mb-0"><code>{{selectedRegistrationDetails.userDetails?._id || 'N/A'}}</code></p>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label text-muted small mb-1">Registration ID</label>
                        <p class="mb-0"><code>{{selectedRegistrationDetails._id}}</code></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Event Information -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="bi bi-calendar-event me-2"></i>Event Information</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Event Title</label>
                  <p class="mb-0 fw-bold">{{getEventTitle(selectedRegistrationDetails)}}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Start Date</label>
                  <p class="mb-0">{{formatDate(getEventStartDate(selectedRegistrationDetails))}}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">End Date</label>
                  <p class="mb-0">{{formatDate(getEventEndDate(selectedRegistrationDetails))}}</p>
                </div>
                <div class="mb-3" *ngIf="selectedRegistrationDetails.eventDetails?.location">
                  <label class="form-label text-muted small mb-1">Location</label>
                  <p class="mb-0">{{selectedRegistrationDetails.eventDetails.location}}</p>
                </div>
                <div *ngIf="selectedRegistrationDetails.eventDetails?.venue">
                  <label class="form-label text-muted small mb-1">Venue</label>
                  <p class="mb-0">{{selectedRegistrationDetails.eventDetails.venue}}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Registration Details -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="bi bi-clipboard-check me-2"></i>Registration Details</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Status</label>
                  <p class="mb-0">
                    <span class="badge rounded-pill" [ngClass]="getRegistrationStatusToggleClass(getRegistrationStatus(selectedRegistrationDetails))">
                      {{getRegistrationStatusText(getRegistrationStatus(selectedRegistrationDetails))}}
                    </span>
                  </p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Ticket Type</label>
                  <p class="mb-0">
                    <span class="badge bg-info">{{selectedRegistrationDetails.registrationDetails?.ticketType?.toUpperCase() || 'N/A'}}</span>
                  </p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Registered At</label>
                  <p class="mb-0">{{formatDate(selectedRegistrationDetails.registrationDetails?.registeredAt)}}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Final Amount</label>
                  <p class="mb-0 fw-bold text-success fs-5">₹{{selectedRegistrationDetails.registrationDetails?.finalAmount || '0.00'}}</p>
                </div>
                <div *ngIf="selectedRegistrationDetails.registrationDetails?.discountAmount">
                  <label class="form-label text-muted small mb-1">Discount Applied</label>
                  <p class="mb-0 text-danger">- ₹{{selectedRegistrationDetails.registrationDetails.discountAmount}}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Coupon Information -->
          <div class="col-md-6" *ngIf="selectedRegistrationDetails.registrationDetails?.appliedCoupon">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="bi bi-ticket-perforated me-2"></i>Coupon Applied</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Coupon Code</label>
                  <p class="mb-0">
                    <span class="badge bg-primary fs-6">{{selectedRegistrationDetails.registrationDetails.appliedCoupon.code}}</span>
                  </p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Coupon Title</label>
                  <p class="mb-0 fw-bold">{{selectedRegistrationDetails.registrationDetails.appliedCoupon.title}}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Discount Type</label>
                  <p class="mb-0">
                    <span class="badge bg-info">{{selectedRegistrationDetails.registrationDetails.appliedCoupon.discountType}}</span>
                  </p>
                </div>
                <div>
                  <label class="form-label text-muted small mb-1">Discount Value</label>
                  <p class="mb-0 fw-bold text-success">
                    {{selectedRegistrationDetails.registrationDetails.appliedCoupon.discountType === 'percentage' 
                      ? selectedRegistrationDetails.registrationDetails.appliedCoupon.discountValue + '%' 
                      : '₹' + selectedRegistrationDetails.registrationDetails.appliedCoupon.discountValue}}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Information -->
          <div class="col-md-6" [class.col-12]="!selectedRegistrationDetails.registrationDetails?.appliedCoupon">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="bi bi-credit-card me-2"></i>Payment Information</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Payment Status</label>
                  <p class="mb-0">
                    <span class="badge rounded-pill" [ngClass]="getPaymentStatusClass(selectedRegistrationDetails)">
                      {{getPaymentStatusText(selectedRegistrationDetails)}}
                    </span>
                  </p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Payment Method</label>
                  <p class="mb-0">
                    <span class="badge bg-secondary">{{selectedRegistrationDetails.paymentDetails?.paymentMethod?.toUpperCase() || 'N/A'}}</span>
                  </p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Amount Paid</label>
                  <p class="mb-0 fw-bold text-success fs-5">₹{{selectedRegistrationDetails.paymentDetails?.amount || '0.00'}}</p>
                </div>
                <div class="mb-3">
                  <label class="form-label text-muted small mb-1">Transaction ID</label>
                  <p class="mb-0"><code>{{getTransactionId(selectedRegistrationDetails)}}</code></p>
                </div>
                <div class="mb-3" *ngIf="getScreenshotUrl(selectedRegistrationDetails)">
                  <label class="form-label text-muted small mb-1">Payment Screenshot</label>
                  <p class="mb-0">
                    <button class="btn btn-sm btn-outline-info rounded-pill" 
                            (click)="openPaymentScreenshot(getScreenshotUrl(selectedRegistrationDetails))"
                            title="View Screenshot">
                      <i class="bi bi-image me-1"></i>View Screenshot
                    </button>
                  </p>
                </div>
                <div *ngIf="selectedRegistrationDetails.paymentDetails?._id">
                  <label class="form-label text-muted small mb-1">Payment ID</label>
                  <p class="mb-0"><code>{{selectedRegistrationDetails.paymentDetails._id}}</code></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Close
        </button>
        <button type="button" class="btn btn-primary rounded-pill" 
                (click)="downloadCard(selectedRegistrationDetails)">
          <i class="bi bi-download me-1"></i>Download Card
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Screenshot Modal -->
<div class="modal fade" id="paymentScreenshotModal" tabindex="-1" role="dialog" aria-labelledby="paymentScreenshotModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="paymentScreenshotModalTitle">
          <i class="bi bi-image me-2"></i>Payment Screenshot
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 text-center" *ngIf="selectedPaymentScreenshot">
        <img [src]="selectedPaymentScreenshot" 
             alt="Payment Screenshot"
             class="img-fluid w-100"
             style="max-height: 70vh; object-fit: contain; background: #f8f9fa;">
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>