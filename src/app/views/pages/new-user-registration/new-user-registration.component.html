<!-- Registrations Table -->
<div class="container-fluid">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div
      class="card-header bg-gradient-primary d-flex justify-content-between align-items-center py-3"
    >
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-person-plus me-2"></i>DMC Registration Management
      </h4>
      <div class="d-flex gap-2">
        <button
          class="btn btn-success rounded-pill px-4"
          (click)="triggerFileInput()"
          [disabled]="importingExcel || previewLoading"
        >
          <i class="bi bi-file-earmark-excel me-2"></i>
          <span *ngIf="!importingExcel && !previewLoading"
            >Import from Excel/CSV</span
          >
          <span *ngIf="importingExcel || previewLoading">
            <span
              class="spinner-border spinner-border-sm me-2"
              role="status"
            ></span>
            <span *ngIf="previewLoading">Loading...</span>
            <span *ngIf="importingExcel">Importing...</span>
          </span>
        </button>
        <input
          type="file"
          #fileInput
          (change)="onFileSelected($event)"
          accept=".xls,.xlsx,.xlsm,.csv"
          style="display: none"
        />
        <button
          class="btn btn-light rounded-pill px-4"
          (click)="openRegisterModal()"
        >
          <i class="bi bi-plus-circle me-2"></i>Register New DMC
        </button>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card-body p-0">
      <div
        class="d-flex flex-wrap justify-content-between align-items-center p-3 border-bottom"
      >
        <div class="flex-grow-1 me-2">
          <input
            type="text"
            class="form-control"
            placeholder="Search registrations..."
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
          />
        </div>
        <div class="ms-2">
          <ng-select
            id="limitSelect"
            [items]="[10, 25, 50, 100]"
            [(ngModel)]="payload.limit"
            (change)="onChange()"
            placeholder="Items per page"
          >
          </ng-select>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="registrationsLoading" class="text-center my-5 py-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Registrations Table -->
    <div
      class="table-responsive"
      *ngIf="!registrationsLoading && registrations.docs.length > 0"
    >
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 py-3">Sr. No.</th>
            <th class="py-3">Name</th>
            <th class="py-3">Business Name</th>
            <th class="py-3">Business Type</th>
            <th class="py-3">Mobile</th>
            <!-- <th class="py-3">Email</th> -->
            <!-- <th class="py-3">Location</th> -->
            <th class="py-3">Specializations</th>
            <th class="py-3">Regions</th>
            <!-- <th class="py-3">Registration Date</th> -->
            <th class="text-center py-3">Action</th>
            <th class="text-center py-3">View Details</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let registration of registrations.docs
                | paginate
                  : {
                      id: paginationConfig.id,
                      itemsPerPage: payload.limit,
                      currentPage: payload.page,
                      totalItems: registrations?.totalDocs
                    };
              let i = index
            "
            class="border-bottom"
          >
            <td class="ps-4 py-3">
              <span class="fw-semibold">{{
                (payload.page - 1) * payload.limit + i + 1
              }}</span>
            </td>
            <td class="py-3">
              <div class="d-flex align-items-center">
                <div>
                  <div class="fw-bold text-dark">
                    {{ registration.name || "Unknown User" }}
                  </div>
                  <small class="text-muted d-block"
                    >ID:
                    {{
                      registration._id
                        ? registration._id.substring(0, 8)
                        : "N/A"
                    }}</small
                  >
                </div>
              </div>
            </td>
            <td class="py-3">
              <div class="fw-semibold">
                {{ registration.business_name || "N/A" }}
              </div>
            </td>
            <td class="py-3">
              <div class="fw-semibold">
                {{ registration?.business?.[0]?.business_type || 'N/A' }}
              </div>
              <!-- Added Business Type display -->
            </td>
            <td class="py-3">
              <span class="d-flex align-items-center">
                <i class="bi bi-telephone-fill text-muted me-2"></i>
                {{ registration.mobile_number || "N/A" }}
              </span>
            </td>
            <!-- <td class="py-3">
              <span class="d-flex align-items-center">
                <i class="bi bi-envelope-fill text-muted me-2"></i>
                {{registration.email || 'N/A'}}
              </span>
            </td> -->
            <!-- <td class="py-3">
              <div class="small">
                <div>{{registration.city || 'N/A'}}, {{registration.state || 'N/A'}}</div>
                <div class="text-muted">{{registration.country || 'N/A'}}</div>
              </div>
            </td> -->
            <td class="py-3">
              <div class="small">
                <span
                  class="badge bg-primary me-1"
                  *ngFor="
                    let spec of registration.dmc_specializations?.slice(0, 2)
                  "
                  >{{ spec }}</span
                >
                <span
                  *ngIf="
                    registration.dmc_specializations &&
                    registration.dmc_specializations.length > 2
                  "
                  class="text-muted"
                  >+{{ registration.dmc_specializations.length - 2 }} more</span
                >
                <span
                  *ngIf="
                    !registration.dmc_specializations ||
                    registration.dmc_specializations.length === 0
                  "
                  class="text-muted"
                  >N/A</span
                >
              </div>
            </td>
            <td class="py-3">
              <div class="small">
                <div
                  *ngFor="let region of registration.regions?.slice(0, 1)"
                  class="mb-1"
                >
                  <span
                    class="badge bg-info me-1 region-tooltip"
                    [attr.data-bs-toggle]="'tooltip'"
                    [attr.data-bs-placement]="'top'"
                    [attr.title]="
                      region.name +
                      ' - Countries: ' +
                      (region.countries.join(', ') || 'N/A')
                    "
                  >
                    {{ region.name }}
                  </span>
                  <small class="text-muted d-block">{{
                    region.countries[0] || "N/A"
                  }}</small>
                </div>
                <span
                  *ngIf="
                    registration.regions && registration.regions.length > 1
                  "
                  class="text-muted region-more-tooltip"
                  [attr.data-bs-toggle]="'tooltip'"
                  [attr.data-bs-placement]="'top'"
                  [attr.title]="getRegionsTooltip(registration.regions)"
                >
                  +{{ registration.regions.length - 1 }} more
                </span>
                <span
                  *ngIf="
                    !registration.regions || registration.regions.length === 0
                  "
                  class="text-muted"
                  >N/A</span
                >
              </div>
            </td>
            <!-- <td class="py-3">
              <span class="small">{{formatDate(registration.createdAt)}}</span>
            </td> -->
            <td class="text-center py-3">
              <button
                class="btn btn-success btn-xs rounded-pill"
                (click)="acceptUser(registration)"
                [disabled]="acceptingUser === registration._id"
                title="Accept User"
              >
                <span
                  *ngIf="acceptingUser === registration._id"
                  class="spinner-border spinner-border-sm"
                  role="status"
                ></span>
                <i
                  *ngIf="acceptingUser !== registration._id"
                  class="bi bi-check-circle-fill"
                ></i>
              </button>
            </td>
            <td class="text-center py-3">
              <button
                class="btn btn-outline-primary btn-xs rounded-circle p-1"
                (click)="openUserDetailsModal(registration)"
                title="View Details"
              >
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div
        class="d-flex justify-content-between align-items-center p-3 border-top"
      >
        <div *ngIf="registrations.docs.length > 0" class="text-muted">
          Showing {{ (payload.page - 1) * payload.limit + 1 }} to
          {{ Math.min(payload.page * payload.limit, registrations.totalDocs) }}
          of {{ registrations.totalDocs }} entries
        </div>
        <pagination-controls
          [id]="paginationConfig.id"
          (pageChange)="onPageChange($event)"
          previousLabel="Previous"
          nextLabel="Next"
          [directionLinks]="true"
        >
        </pagination-controls>
      </div>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="
        !registrationsLoading &&
        (!registrations?.docs || registrations.docs.length === 0)
      "
      class="text-center my-5 py-4 px-4"
    >
      <div class="empty-state">
        <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
        <h5>No Registration Requests</h5>
        <p class="text-muted">
          There are no pending registration requests at the moment.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div
  class="modal fade"
  id="registerModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  role="dialog"
  aria-labelledby="registerModalTitle"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="registerModalTitle">
          <i class="bi bi-person-plus me-2"></i>Register New DMC
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3">
        <form>
          <!-- Personal Information Section -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">Personal Information</h6>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label for="name" class="form-label form-label-sm"
                  >Full Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="name"
                  placeholder="Enter full name"
                  [(ngModel)]="registerForm.name"
                  name="name"
                  required
                  (blur)="onFieldBlur('name')"
                  [class.is-invalid]="validationErrors.name"
                />
                <div class="invalid-feedback" *ngIf="validationErrors.name">
                  {{ validationErrors.name }}
                </div>
              </div>
              <div class="col-md-6 mb-2">
                <label for="email" class="form-label form-label-sm"
                  >Email <span class="text-danger">*</span></label
                >
                <input
                  type="email"
                  class="form-control form-control-sm"
                  id="email"
                  placeholder="Enter email"
                  [(ngModel)]="registerForm.email"
                  name="email"
                  required
                  (blur)="onFieldBlur('email')"
                  [class.is-invalid]="validationErrors.email"
                />
                <div class="invalid-feedback" *ngIf="validationErrors.email">
                  {{ validationErrors.email }}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-2">
                <label for="mobile_number" class="form-label form-label-sm"
                  >Mobile Number <span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-control form-control-sm"
                  id="mobile_number"
                  placeholder="Enter 10-digit mobile number"
                  [(ngModel)]="registerForm.mobile_number"
                  name="mobile_number"
                  required
                  maxlength="10"
                  (input)="onMobileInput($event)"
                  (blur)="onFieldBlur('mobile_number')"
                  [class.is-invalid]="validationErrors.mobile_number"
                />
                <div
                  class="invalid-feedback"
                  *ngIf="validationErrors.mobile_number"
                >
                  {{ validationErrors.mobile_number }}
                </div>
                <small class="text-muted"
                  >Numbers only, exactly 10 digits</small
                >
              </div>
              <div class="col-md-6 mb-2">
                <label for="business_name" class="form-label form-label-sm"
                  >DMC Name<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="business_name"
                  placeholder="Enter DMC name"
                  [(ngModel)]="registerForm.business_name"
                  name="business_name"
                  required
                  (blur)="onFieldBlur('business_name')"
                  [class.is-invalid]="validationErrors.business_name"
                />
                <div
                  class="invalid-feedback"
                  *ngIf="validationErrors.business_name"
                >
                  {{ validationErrors.business_name }}
                </div>
              </div>
            </div>
          </div>

          <!-- Location Information Section -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">Location Details</h6>
            <div class="row">
              <div class="col-md-4 mb-2">
                <label for="country" class="form-label form-label-sm"
                  >Country <span class="text-danger">*</span></label
                >
                <ng-select
                  id="country"
                  [items]="countries"
                  bindLabel="name"
                  bindValue="name"
                  placeholder="Select country"
                  [(ngModel)]="registerForm.country"
                  name="country"
                  required
                  [loading]="countriesLoading"
                  (blur)="onFieldBlur('country')"
                  (change)="onCountryChange()"
                  [class.is-invalid]="validationErrors.country"
                  class="ng-select-sm"
                  [disabled]="
                    !countriesLoaded ||
                    (registerForm.regions && registerForm.regions.length === 0)
                  "
                >
                </ng-select>
                <div class="invalid-feedback" *ngIf="validationErrors.country">
                  {{ validationErrors.country }}
                </div>
                <small
                  class="text-muted"
                  *ngIf="
                    !countriesLoaded ||
                    (registerForm.regions && registerForm.regions.length === 0)
                  "
                >
                  Please select regions first
                </small>
              </div>
              <div class="col-md-4 mb-2">
                <label for="state" class="form-label form-label-sm"
                  >State <span class="text-danger">*</span></label
                >
                <ng-select
                  id="state"
                  [items]="states"
                  bindLabel="name"
                  bindValue="name"
                  placeholder="Select state"
                  [(ngModel)]="registerForm.state"
                  name="state"
                  required
                  [loading]="statesLoading"
                  (blur)="onFieldBlur('state')"
                  (change)="onStateChange()"
                  [class.is-invalid]="validationErrors.state"
                  class="ng-select-sm"
                  [disabled]="!statesLoaded || !registerForm.country"
                >
                </ng-select>
                <div class="invalid-feedback" *ngIf="validationErrors.state">
                  {{ validationErrors.state }}
                </div>
                <small
                  class="text-muted"
                  *ngIf="!statesLoaded || !registerForm.country"
                >
                  Please select country first
                </small>
              </div>
              <div class="col-md-4 mb-2">
                <label for="city" class="form-label form-label-sm"
                  >City <span class="text-danger">*</span></label
                >
                <ng-select
                  id="city"
                  [items]="cities"
                  bindLabel="name"
                  bindValue="name"
                  placeholder="Select city"
                  [(ngModel)]="registerForm.city"
                  name="city"
                  required
                  [loading]="citiesLoading"
                  (blur)="onFieldBlur('city')"
                  [class.is-invalid]="validationErrors.city"
                  class="ng-select-sm"
                  [disabled]="!citiesLoaded || !registerForm.state"
                >
                </ng-select>
                <div class="invalid-feedback" *ngIf="validationErrors.city">
                  {{ validationErrors.city }}
                </div>
                <small
                  class="text-muted"
                  *ngIf="!citiesLoaded || !registerForm.state"
                >
                  Please select state first
                </small>
              </div>
            </div>
          </div>

          <!-- Business Information Section -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">Business Details</h6>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label for="business_type" class="form-label form-label-sm"
                  >Business Type <span class="text-danger">*</span></label
                >
                <ng-select
                  id="business_type"
                  [items]="businessTypes"
                  placeholder="Select business type"
                  [(ngModel)]="registerForm.business_type"
                  name="business_type"
                  required
                  (blur)="onFieldBlur('business_type')"
                  [class.is-invalid]="validationErrors.business_type"
                  class="ng-select-sm"
                >
                </ng-select>
                <div
                  class="invalid-feedback"
                  *ngIf="validationErrors.business_type"
                >
                  {{ validationErrors.business_type }}
                </div>
                <small class="text-muted">Select B2B or B2C</small>
              </div>
              <div class="col-md-6 mb-2"></div>
              <!-- Empty column for alignment if needed -->
            </div>
            <div class="row">
              <div class="col-12 mb-2">
                <label for="regions" class="form-label form-label-sm"
                  >Operating Regions <span class="text-danger">*</span></label
                >
                <ng-select
                  id="regions"
                  [items]="regions"
                  bindLabel="name"
                  bindValue="_id"
                  placeholder="Select regions"
                  [(ngModel)]="registerForm.regions"
                  name="regions"
                  [multiple]="true"
                  required
                  [loading]="regionsLoading"
                  (blur)="onFieldBlur('regions')"
                  (change)="onRegionsChange()"
                  [class.is-invalid]="validationErrors.regions"
                  class="ng-select-sm"
                >
                </ng-select>
                <div class="invalid-feedback" *ngIf="validationErrors.regions">
                  {{ validationErrors.regions }}
                </div>
                <small class="text-muted"
                  >Select all regions where you operate (this will filter
                  countries, states, and cities)</small
                >
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label
                  for="dmc_specializations"
                  class="form-label form-label-sm"
                  >Specializations <span class="text-danger">*</span></label
                >
                <ng-select
                  id="dmc_specializations"
                  [items]="specializations"
                  bindLabel="title"
                  bindValue="title"
                  placeholder="Select specializations"
                  [(ngModel)]="registerForm.dmc_specializations"
                  name="dmc_specializations"
                  [multiple]="true"
                  required
                  (blur)="onFieldBlur('dmc_specializations')"
                  [class.is-invalid]="validationErrors.dmc_specializations"
                  class="ng-select-sm"
                >
                </ng-select>
                <div
                  class="invalid-feedback"
                  *ngIf="validationErrors.dmc_specializations"
                >
                  {{ validationErrors.dmc_specializations }}
                </div>
                <small class="text-muted">Select your area of expertise</small>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary rounded-pill"
          data-bs-dismiss="modal"
        >
          <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary rounded-pill"
          (click)="registerUser()"
          [disabled]="loading || !validateForm()"
        >
          <span
            *ngIf="loading"
            class="spinner-border spinner-border-sm me-2"
            role="status"
          ></span>
          <i *ngIf="!loading" class="bi bi-save me-1"></i>
          {{ loading ? "Registering..." : "Register" }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div
  class="modal fade"
  id="userDetailsModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  role="dialog"
  aria-labelledby="userDetailsModalTitle"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold" id="userDetailsModalTitle">
          <i class="bi bi-person-circle me-2"></i>User Details
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div
        class="modal-body p-4"
        style="max-height: 70vh; overflow-y: auto"
        *ngIf="selectedUserDetails"
      >
        <div class="row g-4">
          <!-- Personal Information -->
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-person me-2"></i>Personal Information
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Full Name</label
                    >
                    <p class="mb-0 fw-bold">
                      {{ selectedUserDetails.name || "N/A" }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Email</label
                    >
                    <p class="mb-0">
                      {{
                        selectedUserDetails.email
                          ? selectedUserDetails.email
                          : "N/A"
                      }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Mobile Number</label
                    >
                    <p class="mb-0">
                      {{ selectedUserDetails.mobile_number || "N/A" }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Registration ID</label
                    >
                    <p class="mb-0">
                      <code>{{ selectedUserDetails._id || "N/A" }}</code>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Location Information -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-geo-alt me-2"></i>Location Details
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label text-muted small mb-1"
                      >Country</label
                    >
                    <p class="mb-0">
                      {{ selectedUserDetails.country || "N/A" }}
                    </p>
                  </div>
                  <div class="col-12">
                    <label class="form-label text-muted small mb-1"
                      >State</label
                    >
                    <p class="mb-0">{{ selectedUserDetails.state || "N/A" }}</p>
                  </div>
                  <div class="col-12">
                    <label class="form-label text-muted small mb-1">City</label>
                    <p class="mb-0">{{ selectedUserDetails.city || "N/A" }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Business Information -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-briefcase me-2"></i>Business Information
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label text-muted small mb-1"
                      >Business Name</label
                    >
                    <p class="mb-0 fw-semibold">
                      {{ selectedUserDetails.business_name || "N/A" }}
                    </p>
                  </div>
                  <div class="col-12">
                    <label class="form-label text-muted small mb-1"
                      >Business Type</label
                    >
                    <p class="mb-0">
                      <span
                        class="badge bg-primary"
                        >{{selectedUserDetails.business?.[0]?.business_type || 'N/A'}}</span
                      >
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Specializations -->
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-star me-2"></i>Specializations
                </h6>
              </div>
              <div class="card-body">
                <div
                  *ngIf="
                    selectedUserDetails.dmc_specializations &&
                    selectedUserDetails.dmc_specializations.length > 0
                  "
                >
                  <span
                    class="badge bg-primary me-1 mb-1"
                    *ngFor="let spec of selectedUserDetails.dmc_specializations"
                    >{{ spec }}</span
                  >
                </div>
                <p
                  *ngIf="
                    !selectedUserDetails.dmc_specializations ||
                    selectedUserDetails.dmc_specializations.length === 0
                  "
                  class="text-muted mb-0"
                >
                  N/A
                </p>
              </div>
            </div>
          </div>
          <!-- Regions -->
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-globe me-2"></i>Operating Regions
                </h6>
              </div>
              <div class="card-body">
                <div
                  *ngIf="
                    selectedUserDetails.regions &&
                    selectedUserDetails.regions.length > 0
                  "
                >
                  <div class="row g-3">
                    <div
                      class="col-md-6"
                      *ngFor="let region of selectedUserDetails.regions"
                    >
                      <div class="border rounded p-3">
                        <h6 class="fw-semibold mb-2">{{ region.name }}</h6>
                        <p class="text-muted small mb-1">
                          <strong>Countries:</strong>
                        </p>
                        <div>
                          <span
                            class="badge bg-info me-1 mb-1"
                            *ngFor="let country of region.countries"
                            >{{ country }}</span
                          >
                        </div>
                        <p
                          *ngIf="region.description"
                          class="text-muted small mt-2 mb-0"
                        >
                          {{ region.description }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                <p
                  *ngIf="
                    !selectedUserDetails.regions ||
                    selectedUserDetails.regions.length === 0
                  "
                  class="text-muted mb-0"
                >
                  N/A
                </p>
              </div>
            </div>
          </div>

          <!-- Registration Date -->
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold">
                  <i class="bi bi-calendar me-2"></i>Registration Information
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Registration Date</label
                    >
                    <p class="mb-0">
                      {{ formatDate(selectedUserDetails.createdAt) }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label text-muted small mb-1"
                      >Last Updated</label
                    >
                    <p class="mb-0">
                      {{
                        selectedUserDetails.updatedAt
                          ? formatDate(selectedUserDetails.updatedAt)
                          : "N/A"
                      }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary rounded-pill"
          data-bs-dismiss="modal"
        >
          <i class="bi bi-x-circle me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Excel Preview and Mapping Modal -->
<div
  class="modal fade"
  id="excelPreviewModal"
  tabindex="-1"
  aria-labelledby="excelPreviewModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title fw-bold" id="excelPreviewModalLabel">
          <i class="bi bi-file-earmark-excel me-2"></i>Import Leads from
          Excel/CSV
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="closePreviewModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div *ngIf="previewLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Parsing Excel file...</p>
        </div>

        <div *ngIf="!previewLoading && excelPreviewData">
          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Map Your Columns</strong> - Match your Excel columns to CRM
            fields below. <strong>Required</strong> indicates recommended
            fields.
          </div>

          <div class="row g-4">
            <!-- Column Mapping Section -->
            <div class="col-lg-4 col-md-5 border-end pe-4">
              <h6 class="fw-bold mb-3">Column Mapping</h6>
              <div class="mb-3">
                <small class="text-muted">
                  <i class="bi bi-file-earmark-text me-1"></i>
                  {{ excelPreviewData.totalRows }} leads found in Excel file
                </small>
              </div>

              <div
                class="mapping-list"
                style="max-height: 70vh; overflow-y: auto"
              >
                <div *ngFor="let field of availableFields" class="mb-3">
                  <label class="form-label fw-semibold small">
                    {{ field.label }}
                    <span *ngIf="field.required" class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="excelColumns"
                    [(ngModel)]="columnMapping[field.key]"
                    [clearable]="!field.required"
                    placeholder="-- Select Field to Map --"
                    class="form-select-sm"
                  >
                  </ng-select>
                  <small
                    *ngIf="columnMapping[field.key]"
                    class="text-muted d-block mt-1"
                  >
                    Sample: {{ getSampleValue(columnMapping[field.key]) }}
                  </small>
                </div>
              </div>
            </div>

            <!-- Data Preview Section -->
            <div class="col-lg-8 col-md-7 ps-4">
              <h6 class="fw-bold mb-3">Data Preview</h6>
              <div class="mb-3">
                <small class="text-muted">
                  All {{ excelPreviewData.totalRows }} rows from your Excel file
                </small>
              </div>

              <div
                class="table-responsive"
                style="max-height: 70vh; overflow-y: auto"
              >
                <table class="table table-sm table-bordered table-hover">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th>#</th>
                      <th
                        *ngFor="let col of excelColumns"
                        [class.bg-warning]="!isColumnMapped(col)"
                      >
                        {{ col }}
                        <small
                          *ngIf="!isColumnMapped(col)"
                          class="d-block text-danger"
                          >Not Mapped</small
                        >
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="
                        let row of excelPreviewData.previewData;
                        let i = index
                      "
                    >
                      <td class="text-muted">{{ i + 1 }}</td>
                      <td *ngFor="let col of excelColumns">
                        {{ row[col] || "-" }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-2 text-end">
                <small class="text-muted"
                  >Total: {{ excelPreviewData.totalRows }} rows</small
                >
                <br />
                <small class="text-muted">Scroll to see all data â†’</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary rounded-pill"
          data-bs-dismiss="modal"
          (click)="closePreviewModal()"
        >
          <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary rounded-pill"
          (click)="importWithMapping()"
          [disabled]="importingExcel || !excelPreviewData"
        >
          <span *ngIf="!importingExcel">
            <i class="bi bi-check-circle me-1"></i>Next: Review Data
          </span>
          <span *ngIf="importingExcel">
            <span
              class="spinner-border spinner-border-sm me-2"
              role="status"
            ></span>
            Importing...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
